name: éƒ¨ç½²æ–‡æ¡£

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'packages/*/src/**'
      - 'src/**'
      - 'typedoc.json'
      - '.github/workflows/docs.yml'
      - 'scripts/update-docs.js'
      - 'scripts/doc-fix.js'
      - 'scripts/fix-module-references.js'
  workflow_dispatch:

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # æ·»åŠ å¹¶å‘æ§åˆ¶ï¼Œé¿å…å¤šä¸ªæ–‡æ¡£éƒ¨ç½²å·¥ä½œæµåŒæ—¶è¿è¡Œ
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'

      # æ·»åŠ ä¾èµ–ç¼“å­˜
      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            .pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "PNPMå®‰è£…ä¸­..."
          pnpm install
          
          # ç¡®ä¿æ–‡æ¡£ç›¸å…³ä¾èµ–å·²å®‰è£…
          pnpm add -D marked typedoc typedoc-plugin-markdown -w
          
          echo "PNPMå®‰è£…å®Œæˆ"

      - name: ä¿®å¤æ–‡æ¡£ç”Ÿæˆ
        run: |
          echo "è¿è¡Œæ–‡æ¡£ä¿®å¤è„šæœ¬..."
          node scripts/doc-fix.js
          echo "æ–‡æ¡£ä¿®å¤è„šæœ¬æ‰§è¡Œå®Œæˆ"

      - name: æ„å»ºæ–‡æ¡£
        run: |
          echo "å¼€å§‹æ„å»ºæ–‡æ¡£..."
          # ä½¿ç”¨æ›´æ–°åçš„æ–‡æ¡£ç”Ÿæˆè„šæœ¬
          NODE_OPTIONS=--max-old-space-size=8192 pnpm docs:build
          
          # ç¡®ä¿.nojekyllæ–‡ä»¶å­˜åœ¨
          touch docs-dist/.nojekyll
          echo "ç¡®ä¿.nojekyllæ–‡ä»¶å­˜åœ¨"

      # æ·»åŠ çŠ¶æ€æ£€æŸ¥æ­¥éª¤
      - name: æ£€æŸ¥æ–‡æ¡£ç”ŸæˆçŠ¶æ€
        id: check_docs
        run: |
          if [ -d "docs-dist" ] && [ "$(ls -A docs-dist)" ]; then
            echo "æ–‡æ¡£ç”ŸæˆæˆåŠŸï¼Œå‡†å¤‡éƒ¨ç½²..."
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "æ–‡æ¡£ç”Ÿæˆå¤±è´¥ï¼Œæ”¾å¼ƒéƒ¨ç½²ï¼"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # ç¡®ä¿APIæ–‡æ¡£å­˜åœ¨
          if [ -d "docs-api" ] && [ -d "docs-dist/api" ]; then
            echo "APIæ–‡æ¡£æ£€æŸ¥é€šè¿‡"
          else
            echo "è­¦å‘Šï¼šAPIæ–‡æ¡£å¯èƒ½ç¼ºå¤±ï¼Œä½†ä»ç»§ç»­éƒ¨ç½²å…¶ä»–æ–‡æ¡£"
          fi

      - name: éƒ¨ç½²åˆ° GitHub Pages
        if: steps.check_docs.outputs.status == 'success'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: docs-dist
          branch: gh-pages
          clean: true
          force: true
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: è‡ªåŠ¨éƒ¨ç½²æ–‡æ¡£ [skip ci]"
          git-config-name: github-actions[bot]
          git-config-email: github-actions[bot]@users.noreply.github.com
          single-commit: true

      # æ·»åŠ éƒ¨ç½²é€šçŸ¥
      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "::notice::ğŸ“š æ–‡æ¡£å·²æˆåŠŸéƒ¨ç½²åˆ° GitHub Pages! è®¿é—® https://agions.github.io/taroviz/ æŸ¥çœ‹æœ€æ–°æ–‡æ¡£ã€‚"
          
      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "::error::âŒ æ–‡æ¡£éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚" 