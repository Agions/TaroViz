name: éƒ¨ç½²æ–‡æ¡£

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'packages/*/src/**'
      - 'src/**'
      - 'typedoc.json'
      - '.github/workflows/docs.yml'
  workflow_dispatch:

# æ·»åŠ æƒé™é…ç½®
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # æ·»åŠ å¹¶å‘æ§åˆ¶ï¼Œé¿å…å¤šä¸ªæ–‡æ¡£éƒ¨ç½²å·¥ä½œæµåŒæ—¶è¿è¡Œ
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'

      # æ·»åŠ ä¾èµ–ç¼“å­˜
      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            .pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
            
      # æ·»åŠ æ–‡æ¡£æ„å»ºç¼“å­˜
      - name: ç¼“å­˜æ–‡æ¡£æ„å»º
        uses: actions/cache@v3
        with:
          path: docs-api
          key: docs-api-${{ hashFiles('packages/*/src/**/*.ts', 'packages/*/src/**/*.tsx', 'typedoc.json') }}

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "PNPMå®‰è£…ä¸­..."
          # è®¾ç½®é…ç½®ï¼Œå¿½ç•¥å·¥ä½œåŒºæ ¹ç›®å½•æ£€æŸ¥ï¼Œä»¥é˜²åç»­æ­¥éª¤å‡ºé”™
          pnpm config set ignore-workspace-root-check true
          pnpm install --no-frozen-lockfile
          
          # å®‰è£…webpack-cliå’Œå…¨å±€ä¾èµ–
          echo "å®‰è£…webpack-cliå’Œå…¶ä»–å¿…è¦ä¾èµ–..."
          npm install -g webpack-cli typescript ts-node typedoc
          
          # ä½¿ç”¨-wæ ‡å¿—å®‰è£…åˆ°å·¥ä½œç©ºé—´æ ¹ç›®å½•
          pnpm add -D webpack-cli -w || npm install -D webpack-cli
          
          # ä¸ºæ¯ä¸ªåŒ…æ·»åŠ webpack-cliï¼Œä½¿ç”¨--filteræ›´å®‰å…¨
          echo "ä¸ºå­åŒ…å®‰è£…webpack-cli..."
          for pkg in packages/*; do
            if [ -d "$pkg" ]; then
              pkg_name=$(basename "$pkg")
              echo "ä¸º $pkg_name å®‰è£…webpack-cli"
              # å°è¯•ä½¿ç”¨filteræ–¹å¼ï¼Œå¦‚æœå¤±è´¥åˆ™ä½¿ç”¨npm
              pnpm --filter="*$pkg_name*" add -D webpack-cli || (cd "$pkg" && npm install -D webpack-cli)
            fi
          done
          
          echo "PNPMå®‰è£…å®Œæˆ"
        
      # æ·»åŠ  typedoc-plugin-markdown æ’ä»¶
      - name: å®‰è£…æ–‡æ¡£æ’ä»¶
        run: pnpm add -D typedoc-plugin-markdown -w

      - name: ä¿®å¤æ¨¡å—å¼•ç”¨
        run: |
          echo "ä¿®å¤æ¨¡å—å¼•ç”¨è·¯å¾„..."
          
          # ä½¿ç”¨pnpmå®‰è£…globï¼Œé¿å…npm workspaceåè®®é—®é¢˜
          pnpm add -D glob -w
          
          # åˆ›å»ºä¸´æ—¶è„šæœ¬æ¥ä¿®å¤å¼•ç”¨è·¯å¾„
          cat > fix-imports.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          const glob = require('glob');
          
          // æŸ¥æ‰¾æ‰€æœ‰TypeScriptæ–‡ä»¶
          const files = glob.sync('packages/*/src/**/*.{ts,tsx}');
          
          // æ›¿æ¢è®¡æ•°
          let replacementCount = 0;
          
          files.forEach(file => {
            const content = fs.readFileSync(file, 'utf8');
            
            // æ›¿æ¢ @taroviz/ ä¸º @agions/taroviz-
            const newContent = content.replace(/@taroviz\//g, '@agions/taroviz-');
            
            // å¦‚æœæœ‰å˜åŒ–ï¼Œä¿å­˜æ–‡ä»¶
            if (content !== newContent) {
              fs.writeFileSync(file, newContent);
              replacementCount++;
              console.log(`Fixed imports in: ${file}`);
            }
          });
          
          console.log(`æ€»å…±ä¿®å¤äº† ${replacementCount} ä¸ªæ–‡ä»¶çš„å¼•ç”¨è·¯å¾„`);
          EOF
          
          # ä½¿ç”¨nodeæ‰§è¡Œè„šæœ¬
          node fix-imports.js

      - name: æ„å»ºæ‰€æœ‰åŒ…
        run: |
          echo "æ„å»ºæ‰€æœ‰åŒ…..."
          # ç¡®ä¿æ‰€æœ‰åŒ…éƒ½èƒ½è¢«ç›¸äº’å¼•ç”¨
          pnpm -r exec -- mkdir -p dist
          echo "å·²åˆ›å»ºä¸´æ—¶distç›®å½•"
          
          # ä¸ºæ¯ä¸ªåŒ…ç”ŸæˆåŸºæœ¬çš„package.json
          for pkg in packages/*; do
            if [ -d "$pkg" ]; then
              echo "å¤„ç†åŒ…: $pkg"
              if [ -f "$pkg/package.json" ]; then
                # ç¡®ä¿æ¯ä¸ªåŒ…çš„distç›®å½•ä¸­æœ‰åŸºæœ¬package.json
                name=$(node -e "console.log(require('./$pkg/package.json').name)")
                echo "{\"name\":\"$name\",\"main\":\"index.js\",\"version\":\"1.0.2\"}" > $pkg/dist/package.json
                
                # å¤åˆ¶srcç›®å½•åˆ°dist/srcï¼Œä»¥ä¾¿TypeDocå¯ä»¥æ‰¾åˆ°æºæ–‡ä»¶
                mkdir -p $pkg/dist/src
                cp -r $pkg/src/* $pkg/dist/src/ 2>/dev/null || :
                
                echo "å·²ä¸º $pkg åˆ›å»ºä¸´æ—¶package.jsonå’Œæºæ–‡ä»¶å¤åˆ¶"
              fi
            fi
          done

      - name: æ„å»ºæ–‡æ¡£
        run: |
          echo "ç¯å¢ƒå˜é‡PATH: $PATH"
          echo "å½“å‰ç›®å½•: $(pwd)"
          
          # ç¡®ä¿å®‰è£…æ‰€æœ‰å¿…è¦çš„å·¥å…·ï¼Œä¸ä½¿ç”¨npm install -gä»¥é¿å…workspaceåè®®é—®é¢˜
          echo "å®‰è£…æ–‡æ¡£ç”Ÿæˆä¾èµ–..."
          pnpm add -g typedoc typescript ts-node
          pnpm add -D @microsoft/api-extractor @microsoft/api-documenter -w
          
          # åˆ›å»ºä¸€ä¸ªå¤‡ç”¨çš„ç®€å•æ–‡æ¡£ç”Ÿæˆè„šæœ¬
          cat > fallback-docs.js << 'EOF'
          const fs = require('fs');
          const path = require('path');
          
          // åˆ›å»ºåŸºæœ¬æ–‡æ¡£
          console.log('ç”ŸæˆåŸºæœ¬æ–‡æ¡£...');
          
          // åˆ›å»ºç›®å½•
          const docsDir = path.join(process.cwd(), 'docs-dist');
          if (!fs.existsSync(docsDir)) {
            fs.mkdirSync(docsDir, { recursive: true });
          }
          
          // å¤åˆ¶READMEåˆ°docsç›®å½•å¹¶åˆ›å»ºindex.html
          if (fs.existsSync('README.md')) {
            fs.copyFileSync('README.md', path.join(docsDir, 'README.md'));
            
            // è¯»å–READMEå†…å®¹ï¼Œè½¬æ¢ä¸ºHTML
            const readmeContent = fs.readFileSync('README.md', 'utf8');
            const htmlContent = `
            <!DOCTYPE html>
            <html>
            <head>
              <title>TaroViz æ–‡æ¡£</title>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <style>
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; color: #333; }
                pre { background: #f6f8fa; padding: 16px; overflow: auto; border-radius: 3px; }
                code { font-family: monospace; background: #f6f8fa; padding: 2px 4px; border-radius: 3px; }
                h1, h2, h3 { margin-top: 24px; margin-bottom: 16px; color: #0d47a1; }
                a { color: #0366d6; text-decoration: none; }
                a:hover { text-decoration: underline; }
                img { max-width: 100%; }
                blockquote { padding: 0 1em; color: #6a737d; border-left: 0.25em solid #dfe2e5; }
                table { border-collapse: collapse; width: 100%; }
                table, th, td { border: 1px solid #ddd; padding: 8px; }
                tr:nth-child(even) { background-color: #f2f2f2; }
              </style>
              <base href="./">
            </head>
            <body>
              <div id="content">
                ${readmeContent.replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>')}
              </div>
            </body>
            </html>
            `;
            
            fs.writeFileSync(path.join(docsDir, 'index.html'), htmlContent);
          }
          
          // å¤åˆ¶æ–‡æ¡£ç›®å½•
          if (fs.existsSync('docs')) {
            const guidesDir = path.join(docsDir, 'guides');
            if (!fs.existsSync(guidesDir)) {
              fs.mkdirSync(guidesDir, { recursive: true });
            }
            
            // å¤åˆ¶docsä¸‹çš„æ‰€æœ‰æ–‡ä»¶
            const copyDir = (src, dest) => {
              const entries = fs.readdirSync(src, { withFileTypes: true });
              for (const entry of entries) {
                const srcPath = path.join(src, entry.name);
                const destPath = path.join(dest, entry.name);
                
                if (entry.isDirectory()) {
                  if (!fs.existsSync(destPath)) {
                    fs.mkdirSync(destPath, { recursive: true });
                  }
                  copyDir(srcPath, destPath);
                } else {
                  // å¦‚æœæ˜¯Markdownæ–‡ä»¶ï¼Œè½¬æ¢ä¸ºHTML
                  if (entry.name.endsWith('.md')) {
                    const mdContent = fs.readFileSync(srcPath, 'utf8');
                    const htmlFileName = entry.name.replace('.md', '.html');
                    const htmlPath = path.join(dest, htmlFileName);
                    
                    const htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                      <title>${entry.name.replace('.md', '')} - TaroViz æ–‡æ¡£</title>
                      <meta charset="UTF-8">
                      <meta name="viewport" content="width=device-width, initial-scale=1.0">
                      <style>
                        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; color: #333; }
                        pre { background: #f6f8fa; padding: 16px; overflow: auto; border-radius: 3px; }
                        code { font-family: monospace; background: #f6f8fa; padding: 2px 4px; border-radius: 3px; }
                        h1, h2, h3 { margin-top: 24px; margin-bottom: 16px; color: #0d47a1; }
                        a { color: #0366d6; text-decoration: none; }
                        a:hover { text-decoration: underline; }
                        img { max-width: 100%; }
                        blockquote { padding: 0 1em; color: #6a737d; border-left: 0.25em solid #dfe2e5; }
                        table { border-collapse: collapse; width: 100%; }
                        table, th, td { border: 1px solid #ddd; padding: 8px; }
                        tr:nth-child(even) { background-color: #f2f2f2; }
                        .nav { margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; }
                        .nav a { margin-right: 15px; }
                      </style>
                      <base href="../">
                    </head>
                    <body>
                      <div class="nav">
                        <a href="index.html">ä¸»é¡µ</a>
                        <a href="guides/USAGE.html">ä½¿ç”¨æŒ‡å—</a>
                        <a href="guides/API.html">APIæ–‡æ¡£</a>
                        <a href="guides/EXAMPLES.html">ç¤ºä¾‹</a>
                      </div>
                      <div id="content">
                        ${mdContent.replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>')}
                      </div>
                    </body>
                    </html>
                    `;
                    
                    fs.writeFileSync(htmlPath, htmlContent);
                    
                    // åŒæ—¶ä¿ç•™åŸå§‹.mdæ–‡ä»¶
                    fs.copyFileSync(srcPath, destPath);
                  } else {
                    fs.copyFileSync(srcPath, destPath);
                  }
                }
              }
            };
            
            try {
              copyDir('docs', guidesDir);
              console.log('å·²å¤åˆ¶æ–‡æ¡£æ–‡ä»¶');
            } catch (err) {
              console.error('å¤åˆ¶æ–‡æ¡£æ–‡ä»¶å¤±è´¥:', err);
            }
          }
          
          // ç”Ÿæˆä¸€ä¸ªç®€å•çš„APIæ–‡æ¡£ç´¢å¼•é¡µ
          const apiIndexPath = path.join(docsDir, 'api-index.html');
          const apiIndexContent = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>TaroViz APIæ–‡æ¡£</title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; color: #333; }
              h1 { color: #0d47a1; }
              .package { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
              .package h2 { margin-top: 0; color: #0d47a1; }
              a { color: #0366d6; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .nav { margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; }
              .nav a { margin-right: 15px; }
              @media (min-width: 768px) {
                body { max-width: 800px; margin: 0 auto; }
              }
            </style>
            <base href="./">
          </head>
          <body>
            <div class="nav">
              <a href="index.html">ä¸»é¡µ</a>
              <a href="guides/USAGE.html">ä½¿ç”¨æŒ‡å—</a>
              <a href="api-index.html">APIæ–‡æ¡£</a>
              <a href="guides/EXAMPLES.html">ç¤ºä¾‹</a>
            </div>
            
            <h1>TaroViz APIæ–‡æ¡£</h1>
            <p>è¿™æ˜¯TaroVizåº“çš„APIæ–‡æ¡£ï¼Œæä¾›äº†æ‰€æœ‰æ ¸å¿ƒåŒ…çš„ä½¿ç”¨è¯´æ˜ï¼š</p>
            
            <div class="package">
              <h2>@agions/taroviz</h2>
              <p>TaroVizæ˜¯åŸºäºTaroå’ŒEChartsçš„å›¾è¡¨ç»„ä»¶åº“ï¼Œæ”¯æŒå¤šç«¯å°ç¨‹åºå’ŒH5ã€‚</p>
            </div>
            
            <div class="package">
              <h2>æ ¸å¿ƒåŒ…</h2>
              <ul>
                <li><strong>@agions/taroviz-core</strong>: æ ¸å¿ƒç»„ä»¶</li>
                <li><strong>@agions/taroviz-charts</strong>: å›¾è¡¨ç»„ä»¶</li>
                <li><strong>@agions/taroviz-hooks</strong>: React Hooks</li>
                <li><strong>@agions/taroviz-themes</strong>: ä¸»é¢˜ç³»ç»Ÿ</li>
                <li><strong>@agions/taroviz-data</strong>: æ•°æ®å¤„ç†</li>
                <li><strong>@agions/taroviz-adapters</strong>: å¹³å°é€‚é…å™¨</li>
              </ul>
            </div>
            
            <p><a href="./guides/USAGE.html">æŸ¥çœ‹ä½¿ç”¨æŒ‡å—</a> | <a href="./index.html">è¿”å›é¦–é¡µ</a></p>
          </body>
          </html>
          `;
          
          fs.writeFileSync(apiIndexPath, apiIndexContent);
          console.log('å·²ç”Ÿæˆä¸´æ—¶APIç´¢å¼•é¡µ');
          
          // åˆ›å»ºå…¨å±€æ ·å¼æ–‡ä»¶
          const cssPath = path.join(docsDir, 'styles.css');
          const cssContent = `
          body { 
            font-family: Arial, sans-serif; 
            line-height: 1.6; 
            color: #333; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
          }
          pre { 
            background: #f6f8fa; 
            padding: 16px; 
            overflow: auto; 
            border-radius: 3px; 
          }
          code { 
            font-family: monospace; 
            background: #f6f8fa; 
            padding: 2px 4px; 
            border-radius: 3px; 
          }
          h1, h2, h3 { 
            margin-top: 24px; 
            margin-bottom: 16px; 
            color: #0d47a1; 
          }
          a { 
            color: #0366d6; 
            text-decoration: none; 
          }
          a:hover { 
            text-decoration: underline; 
          }
          img { 
            max-width: 100%; 
          }
          .nav { 
            margin-bottom: 20px; 
            padding: 10px; 
            background: #f8f9fa; 
            border-radius: 5px; 
          }
          .nav a { 
            margin-right: 15px; 
          }
          `;
          
          fs.writeFileSync(cssPath, cssContent);
          console.log('å·²ç”Ÿæˆå…¨å±€æ ·å¼æ–‡ä»¶');
          
          console.log('åŸºæœ¬æ–‡æ¡£ç”Ÿæˆå®Œæˆã€‚');
          EOF
          
          # åˆ›å»ºä¸€ä¸ªå¤‡ç”¨çš„é¦–é¡µ
          cat > index-template.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>TaroViz - å¤šç«¯å›¾è¡¨ç»„ä»¶åº“</title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
              body { 
                font-family: Arial, sans-serif; 
                line-height: 1.6; 
                color: #333; 
                max-width: 800px; 
                margin: 0 auto; 
                padding: 20px; 
              }
              pre { 
                background: #f6f8fa; 
                padding: 16px; 
                overflow: auto; 
                border-radius: 3px; 
              }
              code { 
                font-family: monospace; 
                background: #f6f8fa; 
                padding: 2px 4px; 
                border-radius: 3px; 
              }
              h1, h2, h3 { 
                margin-top: 24px; 
                margin-bottom: 16px; 
                color: #0d47a1; 
              }
              a { 
                color: #0366d6; 
                text-decoration: none; 
              }
              a:hover { 
                text-decoration: underline; 
              }
              img { 
                max-width: 100%; 
              }
              .nav { 
                margin-bottom: 20px; 
                padding: 10px; 
                background: #f8f9fa; 
                border-radius: 5px; 
              }
              .nav a { 
                margin-right: 15px; 
              }
              .hero {
                padding: 30px 0;
                text-align: center;
                background: #f0f4f8;
                border-radius: 8px;
                margin-bottom: 30px;
              }
              .hero h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
              }
              .hero p {
                font-size: 1.2em;
                color: #666;
              }
              .button {
                display: inline-block;
                padding: 10px 20px;
                background: #0d47a1;
                color: white;
                border-radius: 5px;
                margin-top: 15px;
                font-weight: bold;
              }
              .button:hover {
                background: #0a3880;
                text-decoration: none;
              }
              .features {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-between;
                margin: 30px 0;
              }
              .feature {
                flex: 0 0 48%;
                margin-bottom: 20px;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 5px;
              }
              @media (max-width: 768px) {
                .feature {
                  flex: 0 0 100%;
                }
              }
              .footer {
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid #eee;
                text-align: center;
                font-size: 0.9em;
                color: #666;
              }
            </style>
          </head>
          <body>
            <div class="nav">
              <a href="index.html">ä¸»é¡µ</a>
              <a href="guides/USAGE.html">ä½¿ç”¨æŒ‡å—</a>
              <a href="api-index.html">APIæ–‡æ¡£</a>
              <a href="guides/EXAMPLES.html">ç¤ºä¾‹</a>
            </div>
            
            <div class="hero">
              <h1>TaroViz</h1>
              <p>åŸºäºTaroå’ŒEChartsçš„å¤šç«¯å›¾è¡¨ç»„ä»¶åº“</p>
              <a href="guides/USAGE.html" class="button">å¼€å§‹ä½¿ç”¨</a>
            </div>
            
            <h2>ä»€ä¹ˆæ˜¯TaroViz?</h2>
            <p>TaroVizæ˜¯ä¸€ä¸ªåŸºäºTaroå’ŒEChartsçš„å›¾è¡¨ç»„ä»¶åº“ï¼Œæ—¨åœ¨ä¸ºTaroå¼€å‘è€…æä¾›æ˜“ç”¨ã€é«˜æ•ˆçš„æ•°æ®å¯è§†åŒ–è§£å†³æ–¹æ¡ˆã€‚å®ƒæ”¯æŒå¤šç§å°ç¨‹åºå¹³å°å’ŒH5ï¼Œè®©ä½ çš„æ•°æ®å¯è§†åŒ–èƒ½åŠ›æ›´ä¸Šä¸€å±‚æ¥¼ã€‚</p>
            
            <div class="features">
              <div class="feature">
                <h3>å¤šå¹³å°æ”¯æŒ</h3>
                <p>æ”¯æŒå¾®ä¿¡å°ç¨‹åºã€æ”¯ä»˜å®å°ç¨‹åºã€ç™¾åº¦å°ç¨‹åºç­‰å¤šä¸ªå¹³å°ï¼Œä»¥åŠH5ã€‚</p>
              </div>
              <div class="feature">
                <h3>ä¸°å¯Œçš„å›¾è¡¨ç±»å‹</h3>
                <p>æä¾›æŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾ã€é¥¼å›¾ã€æ•£ç‚¹å›¾ç­‰å¤šç§å›¾è¡¨ç±»å‹ã€‚</p>
              </div>
              <div class="feature">
                <h3>æ˜“äºä½¿ç”¨</h3>
                <p>ç®€å•çš„APIè®¾è®¡ï¼Œå¿«é€Ÿä¸Šæ‰‹ï¼Œè½»æ¾é›†æˆåˆ°Taroåº”ç”¨ä¸­ã€‚</p>
              </div>
              <div class="feature">
                <h3>é«˜åº¦å¯å®šåˆ¶</h3>
                <p>æä¾›ä¸°å¯Œçš„é…ç½®é€‰é¡¹ï¼Œæ”¯æŒè‡ªå®šä¹‰ä¸»é¢˜å’Œäº¤äº’ã€‚</p>
              </div>
            </div>
            
            <h2>å¿«é€Ÿå¼€å§‹</h2>
            <p>ä½¿ç”¨npmæˆ–yarnå®‰è£…TaroVizï¼š</p>
            <pre><code>npm install @agions/taroviz</code></pre>
            <p>æˆ–</p>
            <pre><code>yarn add @agions/taroviz</code></pre>
            
            <p>è¯¦ç»†çš„ä½¿ç”¨æ–¹æ³•ï¼Œè¯·å‚è€ƒ<a href="guides/USAGE.html">ä½¿ç”¨æŒ‡å—</a>ã€‚</p>
            
            <div class="footer">
              <p>Â© 2023 TaroViz å›¢é˜Ÿ</p>
            </div>
          </body>
          </html>
          EOF
          
          # ä½¿ç”¨è‡ªå®šä¹‰è„šæœ¬ç”Ÿæˆæ–‡æ¡£
          cat > generate-docs.js << 'EOF'
          const { execSync } = require('child_process');
          const fs = require('fs');
          const path = require('path');
          
          // åˆ›å»ºdocs-distç›®å½•
          const docsDistDir = path.join(process.cwd(), 'docs-dist');
          if (!fs.existsSync(docsDistDir)) {
            fs.mkdirSync(docsDistDir, { recursive: true });
          }
          
          try {
            // ä»typedoc.jsonè¯»å–é…ç½®
            let typedocConfig = {};
            const typedocPath = path.join(process.cwd(), 'typedoc.json');
            
            if (fs.existsSync(typedocPath)) {
              try {
                typedocConfig = JSON.parse(fs.readFileSync(typedocPath, 'utf8'));
              } catch (err) {
                console.error('è§£ætypedoc.jsonå¤±è´¥:', err);
                typedocConfig = {
                  "entryPoints": ["packages/*/src/index.ts"],
                  "out": "docs-api",
                  "name": "TaroViz APIæ–‡æ¡£"
                };
              }
            } else {
              console.warn('æœªæ‰¾åˆ°typedoc.jsonï¼Œä½¿ç”¨é»˜è®¤é…ç½®');
              typedocConfig = {
                "entryPoints": ["packages/*/src/index.ts"],
                "out": "docs-api",
                "name": "TaroViz APIæ–‡æ¡£"
              };
            }
            
            // åˆ›å»ºä¸´æ—¶tsconfig
            const tsConfig = {
              "compilerOptions": {
                "baseUrl": ".",
                "paths": {
                  "@agions/taroviz-core/*": ["packages/core/src/*"],
                  "@agions/taroviz-charts/*": ["packages/charts/src/*"],
                  "@agions/taroviz-themes/*": ["packages/themes/src/*"],
                  "@agions/taroviz-data/*": ["packages/data/src/*"],
                  "@agions/taroviz-hooks/*": ["packages/hooks/src/*"],
                  "@agions/taroviz-adapters/*": ["packages/adapters/src/*"],
                  "@taroviz/core/*": ["packages/core/src/*"],
                  "@taroviz/charts/*": ["packages/charts/src/*"],
                  "@taroviz/themes/*": ["packages/themes/src/*"],
                  "@taroviz/data/*": ["packages/data/src/*"],
                  "@taroviz/hooks/*": ["packages/hooks/src/*"],
                  "@taroviz/adapters/*": ["packages/adapters/src/*"],
                  "@agions/taroviz-core": ["packages/core/src"],
                  "@agions/taroviz-charts": ["packages/charts/src"],
                  "@agions/taroviz-themes": ["packages/themes/src"],
                  "@agions/taroviz-data": ["packages/data/src"],
                  "@agions/taroviz-hooks": ["packages/hooks/src"],
                  "@agions/taroviz-adapters": ["packages/adapters/src"],
                  "@taroviz/core": ["packages/core/src"],
                  "@taroviz/charts": ["packages/charts/src"],
                  "@taroviz/themes": ["packages/themes/src"],
                  "@taroviz/data": ["packages/data/src"],
                  "@taroviz/hooks": ["packages/hooks/src"],
                  "@taroviz/adapters": ["packages/adapters/src"],
                  "@agions/taroviz": ["packages/all/src"]
                },
                "module": "esnext",
                "target": "es6",
                "moduleResolution": "node",
                "jsx": "react",
                "skipLibCheck": true,
                "esModuleInterop": true,
                "resolveJsonModule": true,
                "allowSyntheticDefaultImports": true,
                "noEmit": true  // ä¸ç”ŸæˆJSæ–‡ä»¶
              },
              "include": [
                "packages/*/src/**/*"
              ],
              "exclude": [
                "node_modules",
                "**/*.test.ts",
                "**/*.test.tsx",
                "**/__tests__/**"
              ]
            };
            
            // å†™å…¥ä¸´æ—¶tsconfig
            fs.writeFileSync('tsconfig.typedoc.json', JSON.stringify(tsConfig, null, 2));
            
            // ä¿®æ”¹typedocé…ç½®
            typedocConfig.out = "docs-api";
            typedocConfig.tsconfig = "tsconfig.typedoc.json";
            
            // ä¸å†æ·»åŠ skipLibChecké€‰é¡¹ï¼Œå› ä¸ºTypeDocä¸æ”¯æŒ
            // typedocConfig.skipLibCheck = true;
            
            // å†™å…¥ä¿®æ”¹åçš„typedocé…ç½®
            fs.writeFileSync('typedoc.temp.json', JSON.stringify(typedocConfig, null, 2));
            
            console.log('è¿è¡ŒTypeDoc...');
            // ä½¿ç”¨pnpxè€Œä¸æ˜¯npxï¼Œé¿å…npm workspaceåè®®é—®é¢˜ï¼Œæ·»åŠ skipErrorCheckingé€‰é¡¹
            execSync('pnpx typedoc --options typedoc.temp.json --skipErrorChecking --logLevel Verbose', { stdio: 'inherit' });
            console.log('TypeDocæ–‡æ¡£ç”ŸæˆæˆåŠŸ!');
            
            // å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
            console.log('å‡†å¤‡éƒ¨ç½²æ–‡ä»¶...');
            
            // å¤åˆ¶APIæ–‡æ¡£
            if (fs.existsSync('docs-api')) {
              console.log('å¤åˆ¶APIæ–‡æ¡£...');
              try {
                execSync('cp -r docs-api/* docs-dist/', { stdio: 'inherit' });
              } catch (err) {
                console.error('å¤åˆ¶APIæ–‡æ¡£å¤±è´¥:', err);
              }
            } else {
              console.warn('æœªæ‰¾åˆ°APIæ–‡æ¡£ç›®å½•ï¼Œå°†ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
              // ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
              require('./fallback-docs.js');
            }
            
            // å¤åˆ¶å…¶ä»–æ–‡æ¡£
            if (fs.existsSync('docs')) {
              console.log('å¤åˆ¶å…¶ä»–æ–‡æ¡£...');
              try {
                execSync('mkdir -p docs-dist/guides', { stdio: 'inherit' });
                execSync('cp -r docs/* docs-dist/guides/', { stdio: 'inherit' });
              } catch (err) {
                console.error('å¤åˆ¶å…¶ä»–æ–‡æ¡£å¤±è´¥:', err);
              }
            }
            
            // å¤åˆ¶README
            if (fs.existsSync('README.md')) {
              console.log('å¤åˆ¶README...');
              try {
                execSync('cp README.md docs-dist/', { stdio: 'inherit' });
              } catch (err) {
                console.error('å¤åˆ¶READMEå¤±è´¥:', err);
              }
            }
            
            console.log('æ–‡æ¡£å‡†å¤‡å®Œæˆ!');
          } catch (error) {
            console.error('æ–‡æ¡£ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºé”™:', error);
            console.log('ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆç”ŸæˆåŸºæœ¬æ–‡æ¡£...');
            // ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
            require('./fallback-docs.js');
          } finally {
            // ç¡®ä¿docs-distç›®å½•å­˜åœ¨ä¸”ä¸ä¸ºç©º
            if (!fs.existsSync('docs-dist') || fs.readdirSync('docs-dist').length === 0) {
              console.log('æœªèƒ½ç”Ÿæˆæ–‡æ¡£ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„å ä½é¡µ...');
              if (!fs.existsSync('docs-dist')) {
                fs.mkdirSync('docs-dist', { recursive: true });
              }
              
              // åˆ›å»ºä¸€ä¸ªç®€å•çš„å ä½é¡µ
              const placeholderContent = `
              <!DOCTYPE html>
              <html>
              <head>
                <title>TaroViz</title>
                <style>
                  body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
                  h1 { color: #333; }
                </style>
              </head>
              <body>
                <h1>TaroViz æ–‡æ¡£</h1>
                <p>æ–‡æ¡£å»ºè®¾ä¸­ï¼Œè¯·ç¨åè®¿é—®ã€‚</p>
              </body>
              </html>
              `;
              
              fs.writeFileSync(path.join('docs-dist', 'index.html'), placeholderContent);
            }
            
            // åˆ›å»º.nojekyllæ–‡ä»¶é˜²æ­¢GitHub Pagesä½¿ç”¨Jekyllå¤„ç†
            fs.writeFileSync(path.join('docs-dist', '.nojekyll'), '');
            console.log('å·²åˆ›å»º.nojekyllæ–‡ä»¶');
            
            // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            try {
              if (fs.existsSync('typedoc.temp.json')) {
                fs.unlinkSync('typedoc.temp.json');
              }
              if (fs.existsSync('tsconfig.typedoc.json')) {
                fs.unlinkSync('tsconfig.typedoc.json');
              }
            } catch (err) {
              console.error('æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:', err);
            }
          }
          EOF
          
          # è¿è¡Œè‡ªå®šä¹‰è„šæœ¬
          NODE_OPTIONS=--max-old-space-size=8192 node generate-docs.js || node fallback-docs.js
          
          # ç¡®ä¿.nojekyllæ–‡ä»¶å­˜åœ¨
          touch docs-dist/.nojekyll
          echo "ç¡®ä¿.nojekyllæ–‡ä»¶å­˜åœ¨"
          
          # å¦‚æœindex.htmlä¸å­˜åœ¨ï¼Œä½¿ç”¨æ¨¡æ¿åˆ›å»º
          if [ ! -f docs-dist/index.html ]; then
            cp index-template.html docs-dist/index.html
            echo "ä½¿ç”¨æ¨¡æ¿åˆ›å»ºäº†index.html"
          fi
          
          # æ·»åŠ  CNAME æ–‡ä»¶ (å¦‚æœæœ‰è‡ªå®šä¹‰åŸŸå)
          if [ -n "$CNAME_VALUE" ]; then
            echo "$CNAME_VALUE" > docs-dist/CNAME
            echo "å·²åˆ›å»ºCNAMEæ–‡ä»¶: $CNAME_VALUE"
          fi
          
          # æ·»åŠ ç«™ç‚¹åœ°å›¾
          cat > docs-dist/sitemap.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
              <loc>https://agions.github.io/taroviz/</loc>
              <lastmod>2023-06-19</lastmod>
              <changefreq>weekly</changefreq>
              <priority>1.0</priority>
            </url>
            <url>
              <loc>https://agions.github.io/taroviz/guides/USAGE.html</loc>
              <changefreq>monthly</changefreq>
              <priority>0.8</priority>
            </url>
            <url>
              <loc>https://agions.github.io/taroviz/guides/API.html</loc>
              <changefreq>monthly</changefreq>
              <priority>0.8</priority>
            </url>
          </urlset>
          EOF
          
          # æ·»åŠ è°·æ­Œç«™ç‚¹éªŒè¯æ–‡ä»¶ (å¦‚æœéœ€è¦)
          echo "google-site-verification: google123456.html" > docs-dist/google123456.html

      # æ·»åŠ çŠ¶æ€æ£€æŸ¥æ­¥éª¤
      - name: æ£€æŸ¥æ–‡æ¡£ç”ŸæˆçŠ¶æ€
        id: check_docs
        run: |
          if [ -d "docs-dist" ] && [ "$(ls -A docs-dist)" ]; then
            echo "æ–‡æ¡£ç”ŸæˆæˆåŠŸï¼Œå‡†å¤‡éƒ¨ç½²..."
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "æ–‡æ¡£ç”Ÿæˆå¤±è´¥ï¼Œæ”¾å¼ƒéƒ¨ç½²ï¼"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: éƒ¨ç½²åˆ° GitHub Pages
        if: steps.check_docs.outputs.status == 'success'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: docs-dist
          branch: gh-pages
          clean: true
          force: true
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "docs: è‡ªåŠ¨éƒ¨ç½²æ–‡æ¡£ [skip ci]"
          git-config-name: github-actions[bot]
          git-config-email: github-actions[bot]@users.noreply.github.com
          single-commit: true

      # æ·»åŠ éƒ¨ç½²é€šçŸ¥
      - name: éƒ¨ç½²å®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "::notice::ğŸ“š æ–‡æ¡£å·²æˆåŠŸéƒ¨ç½²åˆ° GitHub Pages! è®¿é—® https://agions.github.io/taroviz/ æŸ¥çœ‹æœ€æ–°æ–‡æ¡£ã€‚"
          
      - name: éƒ¨ç½²å¤±è´¥é€šçŸ¥
        if: failure()
        run: |
          echo "::error::âŒ æ–‡æ¡£éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚" 